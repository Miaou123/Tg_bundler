// launcher.ts
import { spawn, ChildProcess } from 'child_process';
import * as readline from 'readline';
import * as path from 'path';

const rl = readline.createInterface({
    input: process.stdin,
    output: process.stdout
});

let consoleProcess: ChildProcess | null = null;
let telegramProcess: ChildProcess | null = null;

function showMenu() {
    console.clear();
    console.log('üöÄ PUMP.FUN BUNDLER LAUNCHER');
    console.log('============================');
    console.log('');
    console.log('Choose how you want to run the bundler:');
    console.log('');
    console.log('1. üñ•Ô∏è  Console Only (Original)');
    console.log('2. üì± Telegram Only (Bot)');
    console.log('3. üîÑ Both Console + Telegram');
    console.log('4. ‚öôÔ∏è  Setup & Configuration');
    console.log('5. üÜò Help & Documentation');
    console.log('6. ‚ùå Exit');
    console.log('');
}

function askQuestion(question: string): Promise<string> {
    return new Promise((resolve) => {
        rl.question(question, (answer) => {
            resolve(answer.trim());
        });
    });
}

async function runConsoleOnly() {
    console.log('üñ•Ô∏è  Starting Console Bundler...');
    console.log('=====================================');
    
    consoleProcess = spawn('npx', ['ts-node', 'main.ts'], {
        stdio: 'inherit',
        cwd: process.cwd()
    });
    
    consoleProcess.on('close', (code) => {
        console.log(`\nüñ•Ô∏è  Console process exited with code ${code}`);
        showMenu();
        main();
    });
}

async function runTelegramOnly() {
    console.log('üì± Starting Telegram Bot...');
    console.log('=============================');
    
    // Check if required env vars exist
    if (!process.env.TELEGRAM_BOT_TOKEN) {
        console.log('‚ùå TELEGRAM_BOT_TOKEN not found in .env file');
        console.log('üí° Run option 4 (Setup) to configure');
        await askQuestion('\nPress Enter to continue...');
        showMenu();
        main();
        return;
    }
    
    telegramProcess = spawn('npx', ['ts-node', 'telegram-main.ts'], {
        stdio: 'inherit',
        cwd: process.cwd()
    });
    
    telegramProcess.on('close', (code) => {
        console.log(`\nüì± Telegram process exited with code ${code}`);
        showMenu();
        main();
    });
}

async function runBoth() {
    console.log('üîÑ Starting Both Console + Telegram...');
    console.log('======================================');
    
    if (!process.env.TELEGRAM_BOT_TOKEN) {
        console.log('‚ùå TELEGRAM_BOT_TOKEN not found in .env file');
        console.log('üí° Run option 4 (Setup) to configure');
        await askQuestion('\nPress Enter to continue...');
        showMenu();
        main();
        return;
    }
    
    console.log('üì± Starting Telegram Bot...');
    telegramProcess = spawn('npx', ['ts-node', 'telegram-main.ts'], {
        stdio: ['ignore', 'pipe', 'pipe'],
        cwd: process.cwd()
    });
    
    telegramProcess.stdout?.on('data', (data) => {
        console.log(`[TELEGRAM] ${data.toString().trim()}`);
    });
    
    telegramProcess.stderr?.on('data', (data) => {
        console.log(`[TELEGRAM ERROR] ${data.toString().trim()}`);
    });
    
    // Wait a moment for Telegram to start
    await new Promise(resolve => setTimeout(resolve, 2000));
    
    console.log('\nüñ•Ô∏è  Starting Console Bundler...');
    consoleProcess = spawn('npx', ['ts-node', 'main.ts'], {
        stdio: 'inherit',
        cwd: process.cwd()
    });
    
    consoleProcess.on('close', (code) => {
        console.log(`\nüñ•Ô∏è  Console process exited with code ${code}`);
        if (telegramProcess) {
            telegramProcess.kill();
        }
        showMenu();
        main();
    });
    
    telegramProcess.on('close', (code) => {
        console.log(`\nüì± Telegram process exited with code ${code}`);
        if (consoleProcess) {
            consoleProcess.kill();
        }
    });
}

async function setupConfiguration() {
    console.clear();
    console.log('‚öôÔ∏è  SETUP & CONFIGURATION');
    console.log('=========================');
    console.log('');
    
    console.log('üìã Required for Telegram Bot:');
    console.log('');
    console.log('1. ü§ñ Bot Token from @BotFather');
    console.log('   ‚Ä¢ Open Telegram');
    console.log('   ‚Ä¢ Search for @BotFather');
    console.log('   ‚Ä¢ Send /newbot');
    console.log('   ‚Ä¢ Follow instructions');
    console.log('   ‚Ä¢ Copy the token');
    console.log('');
    
    console.log('2. üë§ Your Telegram User ID');
    console.log('   ‚Ä¢ Search for @userinfobot');
    console.log('   ‚Ä¢ Send /start');
    console.log('   ‚Ä¢ Copy your ID number');
    console.log('');
    
    console.log('3. üìù Add to your .env file:');
    console.log('');
    console.log('   TELEGRAM_BOT_TOKEN=your_bot_token_here');
    console.log('   AUTHORIZED_TELEGRAM_USERS=your_user_id_here');
    console.log('');
    
    console.log('4. üì¶ Install dependencies:');
    console.log('   npm install node-telegram-bot-api @types/node-telegram-bot-api');
    console.log('');
    
    const choice = await askQuestion('üîß Do you want help setting this up now? (y/n): ');
    
    if (choice.toLowerCase() === 'y' || choice.toLowerCase() === 'yes') {
        await interactiveSetup();
    }
    
    await askQuestion('\nPress Enter to return to main menu...');
    showMenu();
    main();
}

async function interactiveSetup() {
    console.log('\nüîß INTERACTIVE SETUP');
    console.log('====================');
    
    const botToken = await askQuestion('\nü§ñ Enter your bot token (from @BotFather): ');
    const userId = await askQuestion('üë§ Enter your Telegram user ID (from @userinfobot): ');
    
    if (botToken && userId) {
        const fs = require('fs');
        const envPath = path.join(process.cwd(), '.env');
        
        try {
            let envContent = '';
            if (fs.existsSync(envPath)) {
                envContent = fs.readFileSync(envPath, 'utf8');
            }
            
            // Add or update Telegram settings
            if (!envContent.includes('TELEGRAM_BOT_TOKEN')) {
                envContent += `\n# Telegram Bot Configuration\n`;
                envContent += `TELEGRAM_BOT_TOKEN=${botToken}\n`;
                envContent += `AUTHORIZED_TELEGRAM_USERS=${userId}\n`;
            } else {
                envContent = envContent.replace(
                    /TELEGRAM_BOT_TOKEN=.*/,
                    `TELEGRAM_BOT_TOKEN=${botToken}`
                );
                envContent = envContent.replace(
                    /AUTHORIZED_TELEGRAM_USERS=.*/,
                    `AUTHORIZED_TELEGRAM_USERS=${userId}`
                );
            }
            
            fs.writeFileSync(envPath, envContent);
            console.log('\n‚úÖ Configuration saved to .env file!');
            
            // Install dependencies
            console.log('\nüì¶ Installing Telegram dependencies...');
            const installProcess = spawn('npm', ['install', 'node-telegram-bot-api', '@types/node-telegram-bot-api'], {
                stdio: 'inherit',
                cwd: process.cwd()
            });
            
            installProcess.on('close', (code) => {
                if (code === 0) {
                    console.log('\n‚úÖ Dependencies installed successfully!');
                    console.log('\nüéâ Setup complete! You can now use the Telegram bot.');
                } else {
                    console.log('\n‚ùå Failed to install dependencies. Please run manually:');
                    console.log('npm install node-telegram-bot-api @types/node-telegram-bot-api');
                }
            });
            
        } catch (error) {
            console.log(`\n‚ùå Error updating .env file: ${error}`);
        }
    } else {
        console.log('\n‚ùå Setup cancelled - missing required information');
    }
}

async function showHelp() {
    console.clear();
    console.log('üÜò HELP & DOCUMENTATION');
    console.log('=======================');
    console.log('');
    
    console.log('üìñ USAGE GUIDE:');
    console.log('');
    console.log('üñ•Ô∏è  CONSOLE MODE:');
    console.log('   ‚Ä¢ Full functionality');
    console.log('   ‚Ä¢ All critical operations');
    console.log('   ‚Ä¢ Interactive prompts');
    console.log('   ‚Ä¢ Best for: Setup, trading, critical ops');
    console.log('');
    
    console.log('üì± TELEGRAM MODE:');
    console.log('   ‚Ä¢ Balance checking');
    console.log('   ‚Ä¢ Status monitoring');
    console.log('   ‚Ä¢ Vanity calculations');
    console.log('   ‚Ä¢ Best for: Monitoring, quick checks');
    console.log('');
    
    console.log('üîÑ BOTH MODES:');
    console.log('   ‚Ä¢ Console for operations');
    console.log('   ‚Ä¢ Telegram for monitoring');
    console.log('   ‚Ä¢ Best for: Active trading/monitoring');
    console.log('');
    
    console.log('üîí SECURITY NOTES:');
    console.log('   ‚Ä¢ Critical ops always use console');
    console.log('   ‚Ä¢ Telegram for read-only operations');
    console.log('   ‚Ä¢ Private keys never sent via Telegram');
    console.log('   ‚Ä¢ User authorization required');
    console.log('');
    
    console.log('üìã REQUIREMENTS:');
    console.log('   ‚Ä¢ Working console bundler');
    console.log('   ‚Ä¢ Telegram bot token');
    console.log('   ‚Ä¢ Your Telegram user ID');
    console.log('   ‚Ä¢ Node.js 16+');
    console.log('');
    
    await askQuestion('Press Enter to return to main menu...');
    showMenu();
    main();
}

async function main() {
    showMenu();
    
    const choice = await askQuestion('Enter your choice (1-6): ');
    
    switch (choice) {
        case '1':
            await runConsoleOnly();
            break;
        case '2':
            await runTelegramOnly();
            break;
        case '3':
            await runBoth();
            break;
        case '4':
            await setupConfiguration();
            break;
        case '5':
            await showHelp();
            break;
        case '6':
            console.log('\nüëã Goodbye!');
            process.exit(0);
            break;
        default:
            console.log('\n‚ùå Invalid choice. Please enter 1-6.');
            await askQuestion('Press Enter to continue...');
            main();
            break;
    }
}

// Handle process termination
process.on('SIGINT', () => {
    console.log('\n\nüõë Shutting down...');
    if (consoleProcess) consoleProcess.kill();
    if (telegramProcess) telegramProcess.kill();
    process.exit(0);
});

process.on('SIGTERM', () => {
    console.log('\n\nüõë Shutting down...');
    if (consoleProcess) consoleProcess.kill();
    if (telegramProcess) telegramProcess.kill();
    process.exit(0);
});

// Start the launcher
console.log('üöÄ Pump.Fun Bundler Launcher Starting...');
main();